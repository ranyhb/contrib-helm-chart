{{- if and .Values.postgresql.enabled .Values.postgresqlMigration.enabled }}
{{- $postgresqlFullname := include "redash.postgresql.fullname" . }}
apiVersion: batch/v1
kind: Job
metadata:
  name: "{{ .Release.Name }}-postgres-migration"
  labels:
    {{- include "redash.labels" . | nindent 4 }}
    app.kubernetes.io/component: postgres-migration
  annotations:
    # This hook runs BEFORE the upgrade to dump the database
    "helm.sh/hook": pre-upgrade
    "helm.sh/hook-weight": "-10"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  ttlSecondsAfterFinished: 3600
  template:
    metadata:
      name: "{{ .Release.Name }}-postgres-migration"
      labels:
        {{- include "redash.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: postgres-migration
    spec:
      serviceAccountName: {{ include "redash.serviceAccountName" . }}
      restartPolicy: Never
      containers:
      - name: postgres-dump
        image: postgres:15-alpine
        command:
          - /bin/sh
          - -c
          - |
            set -e
            echo "Checking for existing PostgreSQL 15 instance..."
            
            # Try to connect to old PostgreSQL instance
            OLD_PG_HOST="{{ $postgresqlFullname }}"
            OLD_PG_USER="{{ .Values.postgresql.auth.username }}"
            OLD_PG_DB="{{ .Values.postgresql.auth.database }}"
            OLD_PG_PASSWORD="{{ .Values.postgresql.auth.password }}"
            
            # Wait for PostgreSQL to be ready
            until PGPASSWORD="$OLD_PG_PASSWORD" psql -h "$OLD_PG_HOST" -U "$OLD_PG_USER" -d "$OLD_PG_DB" -c "SELECT 1;" > /dev/null 2>&1; do
              echo "Waiting for PostgreSQL to be ready..."
              sleep 2
            done
            
            # Check PostgreSQL version
            PG_VERSION=$(PGPASSWORD="$OLD_PG_PASSWORD" psql -h "$OLD_PG_HOST" -U "$OLD_PG_USER" -d "$OLD_PG_DB" -t -c "SELECT version();" | grep -oE '[0-9]+\.[0-9]+' | head -1)
            echo "Current PostgreSQL version: $PG_VERSION"
            
            # Only dump if PostgreSQL version is 15.x (major version 15)
            if echo "$PG_VERSION" | grep -qE '^15\.'; then
              echo "PostgreSQL 15.x detected. Creating database dump..."
              
              # Create dump
              PGPASSWORD="$OLD_PG_PASSWORD" pg_dump -h "$OLD_PG_HOST" -U "$OLD_PG_USER" -d "$OLD_PG_DB" -F c -f /tmp/redash-backup.dump
              
              # Also create SQL dump as backup
              PGPASSWORD="$OLD_PG_PASSWORD" pg_dump -h "$OLD_PG_HOST" -U "$OLD_PG_USER" -d "$OLD_PG_DB" -F p > /tmp/redash-backup.sql
              
              echo "Database dump created successfully"
              ls -lh /tmp/redash-backup.*
              
              # Store dump in a PVC or ConfigMap (we'll use a PVC)
              # Note: This requires a PVC to be created separately or use a shared volume
              echo "Dump files created at /tmp/redash-backup.dump and /tmp/redash-backup.sql"
              echo "IMPORTANT: Copy these files to persistent storage before proceeding!"
            else
              echo "PostgreSQL version is not 15.x (found: $PG_VERSION). Skipping dump."
              echo "If you're upgrading from a different version, manual migration may be required."
            fi
        env:
        - name: PGHOST
          value: {{ $postgresqlFullname }}
        - name: PGPORT
          value: "5432"
        - name: PGUSER
          value: {{ .Values.postgresql.auth.username | quote }}
        - name: PGDATABASE
          value: {{ .Values.postgresql.auth.database | quote }}
        - name: PGPASSWORD
          valueFrom:
            secretKeyRef:
              name: {{ .Release.Name }}-postgresql
              key: postgres-password
        volumeMounts:
        - name: migration-storage
          mountPath: /tmp
      volumes:
      - name: migration-storage
        {{- if .Values.postgresqlMigration.storage }}
        persistentVolumeClaim:
          claimName: {{ .Values.postgresqlMigration.storage.pvcName | default (printf "%s-postgres-migration" .Release.Name) }}
        {{- else }}
        emptyDir: {}
        {{- end }}
---
apiVersion: batch/v1
kind: Job
metadata:
  name: "{{ .Release.Name }}-postgres-restore"
  labels:
    {{- include "redash.labels" . | nindent 4 }}
    app.kubernetes.io/component: postgres-restore
  annotations:
    # This hook runs AFTER the upgrade to restore the database
    "helm.sh/hook": post-upgrade
    "helm.sh/hook-weight": "-6"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  ttlSecondsAfterFinished: 3600
  template:
    metadata:
      name: "{{ .Release.Name }}-postgres-restore"
      labels:
        {{- include "redash.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: postgres-restore
    spec:
      serviceAccountName: {{ include "redash.serviceAccountName" . }}
      restartPolicy: Never
      containers:
      - name: postgres-restore
        image: postgres:18-alpine
        command:
          - /bin/sh
          - -c
          - |
            set -e
            echo "Waiting for PostgreSQL 18 to be ready..."
            
            NEW_PG_HOST="{{ $postgresqlFullname }}"
            NEW_PG_USER="{{ .Values.postgresql.auth.username }}"
            NEW_PG_DB="{{ .Values.postgresql.auth.database }}"
            NEW_PG_PASSWORD="{{ .Values.postgresql.auth.password }}"
            
            # Wait for PostgreSQL 18 to be ready (with timeout)
            MAX_WAIT=300
            WAITED=0
            until PGPASSWORD="$NEW_PG_PASSWORD" psql -h "$NEW_PG_HOST" -U "$NEW_PG_USER" -d "$NEW_PG_DB" -c "SELECT 1;" > /dev/null 2>&1; do
              if [ $WAITED -ge $MAX_WAIT ]; then
                echo "ERROR: PostgreSQL 18 did not become ready within $MAX_WAIT seconds"
                exit 1
              fi
              echo "Waiting for PostgreSQL 18 to be ready... ($WAITED/$MAX_WAIT seconds)"
              sleep 5
              WAITED=$((WAITED + 5))
            done
            
            echo "PostgreSQL 18 is ready. Checking for dump files and database state..."
            
            # Check if database already has Redash data (check for alembic_version table which indicates migrations have run)
            HAS_REDASH_DATA=$(PGPASSWORD="$NEW_PG_PASSWORD" psql -h "$NEW_PG_HOST" -U "$NEW_PG_USER" -d "$NEW_PG_DB" -t -c "SELECT COUNT(*) FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'alembic_version';" 2>/dev/null | tr -d ' ' || echo "0")
            TABLE_COUNT=$(PGPASSWORD="$NEW_PG_PASSWORD" psql -h "$NEW_PG_HOST" -U "$NEW_PG_USER" -d "$NEW_PG_DB" -t -c "SELECT COUNT(*) FROM information_schema.tables WHERE table_schema = 'public';" 2>/dev/null | tr -d ' ' || echo "0")
            
            # Check if dump files exist
            if [ -f /tmp/redash-backup.dump ] || [ -f /tmp/redash-backup.sql ]; then
              # Only restore if database is empty or doesn't have Redash data yet
              if [ "$HAS_REDASH_DATA" = "0" ] && [ "$TABLE_COUNT" = "0" ]; then
                echo "Database is empty. Restoring from dump file..."
                
                if [ -f /tmp/redash-backup.dump ]; then
                  # Restore from custom dump format
                  echo "Restoring from dump file..."
                  PGPASSWORD="$NEW_PG_PASSWORD" pg_restore -h "$NEW_PG_HOST" -U "$NEW_PG_USER" -d "$NEW_PG_DB" -v --no-owner --no-privileges /tmp/redash-backup.dump || {
                    echo "pg_restore failed, trying SQL restore..."
                    if [ -f /tmp/redash-backup.sql ]; then
                      PGPASSWORD="$NEW_PG_PASSWORD" psql -h "$NEW_PG_HOST" -U "$NEW_PG_USER" -d "$NEW_PG_DB" < /tmp/redash-backup.sql
                    else
                      echo "ERROR: SQL dump file not found"
                      exit 1
                    fi
                  }
                elif [ -f /tmp/redash-backup.sql ]; then
                  echo "Restoring from SQL dump file..."
                  PGPASSWORD="$NEW_PG_PASSWORD" psql -h "$NEW_PG_HOST" -U "$NEW_PG_USER" -d "$NEW_PG_DB" < /tmp/redash-backup.sql
                fi
                
                echo "Database restore completed successfully"
                
                # Clean up dump files after successful restore to prevent re-restoration on future upgrades
                echo "Cleaning up dump files to prevent re-restoration..."
                rm -f /tmp/redash-backup.dump /tmp/redash-backup.sql
                echo "Dump files cleaned up."
              else
                echo "Database already contains data (found $TABLE_COUNT tables, Redash data: $HAS_REDASH_DATA)."
                echo "Skipping restore - migration has already been completed."
                echo "Cleaning up old dump files..."
                rm -f /tmp/redash-backup.dump /tmp/redash-backup.sql
              fi
            else
              if [ "$HAS_REDASH_DATA" = "1" ] || [ "$TABLE_COUNT" -gt 0 ]; then
                echo "Database already contains data. No migration needed."
              else
                echo "WARNING: No dump files found and database is empty."
                echo "This might be expected if:"
                echo "  1. This is a fresh installation"
                echo "  2. PostgreSQL was not version 15.x before upgrade"
                echo "  3. Migration storage (PVC) was not configured correctly"
                echo ""
                echo "Skipping restore. Redash schema migrations will run next."
              fi
            fi
        env:
        - name: PGHOST
          value: {{ $postgresqlFullname }}
        - name: PGPORT
          value: "5432"
        - name: PGUSER
          value: {{ .Values.postgresql.auth.username | quote }}
        - name: PGDATABASE
          value: {{ .Values.postgresql.auth.database | quote }}
        - name: PGPASSWORD
          valueFrom:
            secretKeyRef:
              name: {{ .Release.Name }}-postgresql
              key: postgres-password
        volumeMounts:
        - name: migration-storage
          mountPath: /tmp
      volumes:
      - name: migration-storage
        {{- if .Values.postgresqlMigration.storage.pvcName }}
        persistentVolumeClaim:
          claimName: {{ .Values.postgresqlMigration.storage.pvcName }}
        {{- else }}
        emptyDir: {}
        {{- end }}
{{- end }}
